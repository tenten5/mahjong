<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Mahjong Wait Quiz</title>
    <script src="mahjong.js"></script>
    <style>
      .tile {
        width: 66px;
        height: 90px;
        background-size: cover;
        background-repeat: no-repeat;
        display: inline-block;
        margin: 1px;
      }
    </style>
  </head>
  <body>
    <h1>Mahjong Wait Quiz</h1>
    <div id="cr">画像は https://majandofu.com/mahjong-images より借りてます</div>
    <p>
    <div id="hand"></div>
    <div>
      <input id="tiles-input" type="hidden" size="100">
      <button id="calculate-button">待ち表示！</button>
    </div>
    <div id="result"></div>
    <script>
      const calculateButton = document.getElementById("calculate-button");
      const tilesInput = document.getElementById("tiles-input");
      const resultDiv = document.getElementById("result");

      haishi = generateRandomTenpai();

      const tileImages = [
        "man1-66-90-l.png", "man2-66-90-l.png", "man3-66-90-l.png", "man4-66-90-l.png", "man5-66-90-l.png", "man6-66-90-l.png", "man7-66-90-l.png", "man8-66-90-l.png", "man9-66-90-l.png",
        "pin1-66-90-l.png", "pin2-66-90-l.png", "pin3-66-90-l.png", "pin4-66-90-l.png", "pin5-66-90-l.png", "pin6-66-90-l.png", "pin7-66-90-l.png", "pin8-66-90-l.png", "pin9-66-90-l.png",
        "sou1-66-90-l.png", "sou2-66-90-l.png", "sou3-66-90-l.png", "sou4-66-90-l.png", "sou5-66-90-l.png", "sou6-66-90-l.png", "sou7-66-90-l.png", "sou8-66-90-l.png", "sou9-66-90-l.png",
        "ji1-66-90-l.png", "ji2-66-90-l.png", "ji3-66-90-l.png", "ji4-66-90-l.png", "ji5-66-90-l.png", "ji6-66-90-l.png", "ji7-66-90-l.png"
      ];

      function tileToImageSrc(tile) {
        return "https://majandofu.com/wp-content/uploads/2014/09/" + tileImages[tile] ;
      }

      function renderHand(tiles) {
        const handDiv = document.getElementById("hand");
        handDiv.innerHTML = "";
        for (let i = 0; i < tiles.length; i++) {
          const tile = tiles[i];
          for (let j = 0; j < tile; j++) {
            const tileDiv = document.createElement("div");
            tileDiv.classList.add("tile");
            tileDiv.style.backgroundImage = "url('" + tileToImageSrc(i) + "')";
            handDiv.appendChild(tileDiv);
          }
        }
      }
      
      renderHand(haishi);
      
      tilesInput.value = tilesToString(haishi);

      calculateButton.addEventListener("click", () => {
        const tiles = parseTiles(tilesInput.value);
        let totalTiles = tiles.reduce((sum, tile) => sum + tile, 0);
        if (totalTiles !== 13) {
          alert("手牌が不正です");
          return;
        }
        const waits = calculateWait(tiles);
        if (waits.length === 0) {
          resultDiv.textContent = "聴牌していません。";
        } else {
          resultDiv.textContent = `聴牌待ち：${waits.join(", ")}`;
        }
      });

      function parseTiles(tilesText) {
        const tiles = new Array(34).fill(0);
        for (let i = 0; i < tilesText.length; i += 2) {
          const num = Number(tilesText[i]);
          const suit = tilesText[i + 1];
          let index;
          if (suit === "m") {
            index = num - 1;
          } else if (suit === "p") {
            index = 9 + num - 1;
          } else if (suit === "s") {
            index = 18 + num - 1;
          } else if (suit === "z") {
            index = 27 + num - 1;
          } else {
            return [];
          }
          tiles[index]++;
        }
        return tiles;
      }
    </script>
  </body>
</html>